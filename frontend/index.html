<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bus Maintenance Log</title>

<style>
    /* ---------- General Styles ---------- */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: #f4f7f9;
        margin: 0;
        padding: 20px;
        color: #333;
    }

    .container {
        max-width: 1100px;
        margin: 0 auto;
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    h1, h2 {
        color: #2c3e50;
    }

    h2 {
        margin-bottom: 15px;
        text-align: center;
    }

    input[type="text"], input[type="month"], input[type="password"], input[type="email"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }

    .btn-primary {
        background: #007bff;
        color: #fff;
        font-weight: bold;
        width: 100%;
        margin-bottom: 10px;
    }

    .btn-primary:hover { background: #0069d9; }

    .btn-success {
        background: #28a745;
        color: #fff;
        font-weight: bold;
        width: 100%;
    }

    .btn-success:hover { background: #218838; }

    .btn-danger {
        background: #dc3545;
        color: #fff;
        font-size: 14px;
        padding: 8px 16px;
    }

    .btn-danger:hover { background: #c82333; }

    .btn-logout {
        background: #6c757d;
        color: #fff;
        padding: 8px 16px;
        margin-bottom: 20px;
    }

    .btn-logout:hover { background: #5a6268; }

    /* ---------- Header with Logo ---------- */
    .header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    .header img {
        height: 50px;
        width: auto;
    }

    /* ---------- Form and Table Styles ---------- */
    .top-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }

    .form-container {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dfe6e9;
        flex: 1;
        min-width: 280px;
    }

    .table-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        min-width: 900px;
    }

    th, td {
        border: 1px solid #dfe6e9;
        padding: 12px 15px;
        text-align: left;
    }

    th {
        background: #4a6fa5;
        color: #fff;
        font-weight: bold;
    }

    tr:nth-child(even){ background: #f8f9fa; }

    td[contenteditable="true"] {
        background: #eaf2f8;
        cursor: pointer;
    }

    td[contenteditable="true"]:focus {
        background: #d4e6f1;
        outline: 2px solid #3498db;
    }

    .print-btn {
        background: #007bff;
        color: #fff;
        display: block;
        width: 100%;
        max-width: 200px;
        margin: 20px auto 0;
    }

    .print-btn:hover { background: #0069d9; }

    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 8px;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    /* ---------- Print Styles ---------- */
    @media print {
        .form-container, .print-btn, .header, .user-info, .btn-logout { display: none !important; }
        .action-column, td:last-child { display: none !important; }
        table { min-width: 100% !important; }
        th, td { border: 1px solid #000; font-size: 12pt; padding: 8px; }
        th { background: #ddd !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
        tr:nth-child(even){ background: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
        td[contenteditable="true"]{ background: transparent; }
    }

</style>
</head>

<body>

<div class="container">
    <!-- Header with logo on the left -->
    <div class="header">
        <img src="MSRTC logo.avif" alt="MSRTC Logo">
        <h1> Bus Maintenance Log</h1>
    </div>

    <!-- Message alert -->
    <div id="message"></div>

    <!-- Main bus section (hidden if not logged in) -->
    <div id="bus-section" style="display:none;">
        <!-- User info and logout -->
        <div class="user-info">
            <span id="welcome-text">Welcome!</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <!-- Add new bus form -->
        <div class="top-section">
            <div class="form-container">
                <h2>Add New Bus</h2>
                <input type="text" id="busNumber" placeholder="Bus Number (e.g., MH14-XX1234)">
                <input type="month" id="monthSelect">
                <button class="btn-success" onclick="addBus()">Add Bus</button>
            </div>
        </div>

        <!-- Bus table -->
        <div class="table-wrapper">
            <table id="busTable">
                <thead>
                    <tr>
                        <th>Bus Number</th>
                        <th>Battery 1</th>
                        <th>Battery 2</th>
                        <th>Starter</th>
                        <th>Alternator</th>
                        <th contenteditable="true">ETC1</th>
                        <th contenteditable="true">ETC2</th>
                        <th>Date</th>
                        <th class="action-column">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button class="print-btn" onclick="window.print()">Print All Data</button>
    </div>
</div>

<script>
/* ---------- Session & Auth Handling ---------- */
let sessionData = { token: null, username: null };
const busTable = document.getElementById('busTable').querySelector('tbody');
const monthInput = document.getElementById('monthSelect');
const messageDiv = document.getElementById('message');
monthInput.value = new Date().toISOString().slice(0,7);

// Normalize bus number (remove spaces & hyphens)
function normalizeBusNumber(busNumber) {
    return busNumber.replace(/[\s-]/g, '').toUpperCase();
}

// Initialize auth session
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get('token');
    const usernameFromUrl = urlParams.get('username');
    
    if (tokenFromUrl && usernameFromUrl) {
        sessionData.token = decodeURIComponent(tokenFromUrl);
        sessionData.username = decodeURIComponent(usernameFromUrl);
        window.history.replaceState({}, document.title, window.location.pathname);
    } else {
        try {
            sessionData.token = sessionStorage.getItem('token');
            sessionData.username = sessionStorage.getItem('username');
        } catch (e) {}
    }
    checkAuthStatus();
}
initializeAuth();

// Show message alerts
function showMessage(text, type = 'danger') {
    messageDiv.className = `alert alert-${type}`;
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';
    setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
}

// Check authentication
function checkAuthStatus() {
    if(!sessionData.token) {
        showMessage('⚠️ Please login first.', 'danger');
        setTimeout(() => { window.location.href = "login.html"; }, 1500);
    } else {
        document.getElementById('bus-section').style.display = 'block';
        document.getElementById('welcome-text').textContent = `Welcome, ${sessionData.username}!`;
        fetchBuses();
    }
}

// Logout function
function logout() {
    sessionData.token = null;
    sessionData.username = null;
    try { sessionStorage.removeItem('token'); sessionStorage.removeItem('username'); } catch (e) {}
    showMessage('Logged out successfully', 'success');
    setTimeout(() => { window.location.href = "login.html"; }, 1000);
}

/* ---------- Bus CRUD Functions ---------- */

// Fetch buses
function fetchBuses() {
    if(!sessionData.token) return;
    fetch(`https://msrtc.onrender.com/buses?month=${monthInput.value}`, {
        headers: {'Authorization': 'Bearer ' + sessionData.token}
    })
    .then(res => { 
        if(res.status === 401){ showMessage('Session expired. Please login again.'); logout(); return; } 
        return res.json(); 
    })
    .then(data => {
        if(!data) return;
        busTable.innerHTML = '';
        data.forEach(bus => {
            const tr = busTable.insertRow();
            tr.dataset.id = bus.id;
            tr.insertCell(0).textContent = bus.bus_number;

            const editableFields = ['battery1','battery2','starter','alternator','etc1','etc2'];
            editableFields.forEach((key,i) => {
                const td = tr.insertCell(i+1);
                td.textContent = bus[key] || 'Status';
                td.contentEditable = true;
                td.addEventListener('blur', () => updateBus(tr.dataset.id, key, td.textContent));
                td.addEventListener('keypress', (e) => { if(e.key==='Enter'){ td.blur(); }});
            });

            // Date column
            const dateTd = tr.insertCell(7);
            const today = new Date().toISOString().slice(0,10);
            dateTd.textContent = bus.date ? new Date(bus.date).toISOString().slice(0,10) : today;
            dateTd.contentEditable = true;
            dateTd.addEventListener('blur', () => updateBus(tr.dataset.id, "date", dateTd.textContent));
            dateTd.addEventListener('keypress', (e) => { if(e.key==='Enter'){ dateTd.blur(); }});

            // Delete button
            const actionTd = tr.insertCell(8);
            actionTd.innerHTML = `<button class="btn-danger" onclick="deleteBus(${bus.id})">Delete</button>`;
        });
    })
    .catch(err => { console.error(err); showMessage('Failed to fetch buses'); });
}

// Add new bus
function addBus() {
    let busNumber = document.getElementById('busNumber').value.trim();
    if(!busNumber){ showMessage('Please enter a bus number'); return; }
    const normalized = normalizeBusNumber(busNumber);
    const today = new Date().toISOString().slice(0,10);

    // Prevent duplicate
    const existing = Array.from(busTable.querySelectorAll("tr")).some(row => {
        return normalizeBusNumber(row.cells[0].textContent) === normalized;
    });
    if(existing){ showMessage("This bus number already exists!", "danger"); return; }

    fetch('https://msrtc.onrender.com/buses', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+sessionData.token},
        body:JSON.stringify({busNumber:normalized,date:today})
    })
    .then(res=>res.json())
    .then(data=>{ 
        if(data.id){ 
            showMessage('Bus added successfully!','success'); 
            document.getElementById('busNumber').value=''; 
            fetchBuses(); 
        } else { 
            showMessage(data.message || 'Failed to add bus'); 
        }
    })
    .catch(err=>{ console.error(err); showMessage('Failed to add bus'); });
}

// Update bus
function updateBus(id,field,value){
    fetch(`https://msrtc.onrender.com/buses/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+sessionData.token},
        body:JSON.stringify({[field]:value})
    })
    .then(res=>res.json())
    .then(data=>{ if(data.message && data.message.includes('successfully')){ showMessage('Updated successfully!','success'); }})
    .catch(err=>{ console.error(err); showMessage('Failed to update'); });
}

function deleteBus(id){
    if(!confirm('Are you sure you want to delete this bus record?')) return;

    fetch(`https://msrtc.onrender.com/buses/${id}`, { 
        method:'DELETE', 
        headers:{'Authorization':'Bearer '+sessionData.token}
    })
    .then(res=>{
        if(!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
    })
    .then(data=>{ 
        showMessage(data.message || 'Bus deleted successfully!','success'); 
        fetchBuses(); 
    })
    .catch(err=>{
        console.error(err); 
        showMessage('Failed to delete bus'); 
    });
}


// Fetch buses when month changes
monthInput.addEventListener('change', fetchBuses);
</script>

</body>
</html>
